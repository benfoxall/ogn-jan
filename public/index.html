<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>reveal.js - The HTML Presentation Framework</title>

		<meta name="description" content="A framework for easily creating beautiful presentations using HTML">
		<meta name="author" content="Hakim El Hattab">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.min.css">
		<link rel="stylesheet" href="css/theme/simple.css" id="theme">

		<style type="text/css">
			.image-panels{
				display:flex;
			}
			.reveal .image-panel{
				flex-grow:1;
				margin:.5%;
			}
			.image-panel canvas{
				display:block;
				margin:auto;
				max-width: 100%;
			}
		</style>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">
			<div class="slides">
				<section>
					<h1>ping pong</h1>
				</section>

				<section data-background="images/ping-pong.jpg">
				</section>

				<section>
					<section>
						<div class="image-panels">
							<div id="r" class="image-panel"></div>
							<div id="g" class="image-panel"></div>
							<div id="b" class="image-panel"></div>
						</div>
					</section>
					<section data-state="rgbslide">
						<div id="rgb"></div>
					</section>
				</section>

				<section>
					<h1>[picture]</h1>
					<p>*[when this doesn't work]*</p>
				</section>

				<section>
					<section>
						<h1>RGB -> HSL</h1>
					</section>
					<section>
						<h1>[why this works better]</h1>
						<p>[3d plot?]</p>
					</section>
				</section>

				<section>
					<h1>[LETS DO THIS]</h1>
				</section>

				<section>
					<h1>[DRAW PICTURE]</h1>
				</section>

				<section>
					<h1>[CONTROL STUFF - 3d plot?!]</h1>
				</section>

				<section>
					<h1>[CHRISTMAS PARTY]</h1>
				</section>

				<section>
					<h1>[HERE'S A BLOG POST &amp; REPO]</h1>
					<p>I've got PING PONG BALLS</p>
				</section>

				<section>
					<h1>[JSOxford!!!!!]</h1>
				</section>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.min.js"></script>

		<script>

			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: false,
				progress: true,
				history: true,
				center: true,

				theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
				transition: Reveal.getQueryHash().transition || 'linear', // default/cube/page/concave/zoom/linear/fade/none

				// Optional libraries used to extend on reveal.js
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
					{ src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
				]
			});


			// return a canvas with an image drawn to it
			function imageCanvas(image, width, height){
				var canvas = document.createElement('canvas');

				canvas.width  = width  || image.width;
				canvas.height = height || image.height;

				canvas.getContext('2d').drawImage(image, 0, 0, canvas.width,canvas.height);

				return canvas;
			}

			// add histX to an event before passing on to the handler
			function histX(canvas, fn){
				var slidestyle = document.querySelector('.slides').style;
				return function(e){
					e.histX = ((400/300)*255*(e.offsetX / slidestyle.zoom)/canvas.offsetWidth)-50;
					fn.apply(this, arguments);
				}
			}

			// load the image into the visuals

			var image = document.createElement('img');
			image.addEventListener("load", setup, false);
			image.src = 'images/ping-pong.jpg';

			var rgbCanvas, maxes = [], mins = [];

			// MASSIVE CLEANUP PLEASE

			function setup(){

				// onscreen full size canvas (next slide)
				rgbCanvas = imageCanvas(image);
				document.querySelector('#rgb').appendChild(rgbCanvas);


				// offscreen source canvas (scaled to width 400)
				var destH = (image.height / image.width)*400;
				var srcCanvas = imageCanvas(image, 400, destH);
				var srcCtx = srcCanvas.getContext('2d');


				['#r','#g','#b'].forEach(function(selector, idx){

					var canvas = document.createElement('canvas');
					canvas.width=400; canvas.height=600;
					var ctx = canvas.getContext('2d');

					
					var started = false, start, end;
					
					function draw(){
						// uint16 = 0xFFFF
						var buckets = new Uint16Array(255)
					
						var srcImageData = srcCtx.getImageData(0,0,srcCanvas.width,srcCanvas.height);
						var pixels = srcImageData.data; 
						var min = mins[idx] = Math.min(start, end), 
								max = maxes[idx] = Math.max(start, end);
						for(var i = pixels.length; i > 0; i--){
							if (i%4 === idx ){
								buckets[pixels[i]]++
								if(start){
									pixels[i] = (pixels[i] > min && pixels[i] < max) ? 255: 0
								} 
							} else {
								// zero, unless alpha value
								if(i%4 !== 3) pixels[i] = 0;
							}
						}
						ctx.putImageData(srcImageData, 0, 0);

						ctx.clearRect(0, destH, canvas.width, canvas.height - destH)

						// draw hist
						// 50px padding
						var gap = 300/255;

						ctx.fillStyle = idx == 0 ? '#f00' :
														idx == 1 ? '#0f0' :
														idx == 2 ? '#00f' : '#000'

						for (var i = buckets.length - 1; i >= 0; i--) {
							ctx.fillRect(
								Math.floor(i*gap) + 50, 
								canvas.height - buckets[i]/10, 
								Math.ceil(gap), 
								buckets[i]/10)
							;
						};

						ctx.fillStyle = 'rgba(0,0,0,0.4)'
						if(start){
							ctx.fillRect(
								((start/255)*300) + 50,
								destH,
								((end/255)*300) - ((start/255)*300),
								canvas.height - destH
							)
						}
					}

					draw();

					canvas.addEventListener("mousedown", histX(canvas, function(e) {
						started = true;
						start = e.histX;
						console.log(e);
						end = start;
						draw();
						e.preventDefault();
					}));
					canvas.addEventListener("mouseup", histX(canvas, function(e) {
						started = false;
						end = e.histX;
						if(start == end) start = end = null;
						draw();
						e.preventDefault();
					}));
					canvas.addEventListener("mouseleave", histX(canvas, function(e) {
						started = false;
						end = e.histX;
						if(start == end) start = end = null;
						e.preventDefault();
					}));


					canvas.addEventListener("mousemove", histX(canvas, function(e) {
						// console.log(e);

						// 0 -> 1 
						if(started){
							end = e.histX;
							draw();
							// console.log(255*(e.layerX / slidestyle.zoom)/canvas.offsetWidth);
						}
							

					}));

					document.querySelector(selector).appendChild(canvas);

				})
			}


			Reveal.addEventListener( 'rgbslide', function() {

    		var ctx = rgbCanvas.getContext('2d');
    				ctx.drawImage(image,0,0);

				var srcImageData = ctx.getImageData(0,0,rgbCanvas.width,rgbCanvas.height);
				var pixels = srcImageData.data;
				for(var i = 0; i < pixels.length; i+=4){
					if( 
						pixels[i] < maxes[0] && pixels[i] > mins[0] && 
						pixels[i+1] < maxes[1] && pixels[i] > mins[1] &&
						pixels[i+2] < maxes[2] && pixels[i] > mins[2]
					){
						pixels[i] = pixels[i+1] = pixels[i+2] = 0;
					} else {
						pixels[i] = pixels[i+1] = pixels[i+2] = 255;
					}
				}

				ctx.putImageData(srcImageData, 0, 0);

			}, false );

		

		</script>

	</body>
</html>
